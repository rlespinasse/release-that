name: Release that
on: [push, pull_request]
permissions: read-all
jobs:
  os-testing:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    concurrency:
      group: os-testing-${{ github.ref }}-${{ github.event_name }}-${{ matrix.os }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # test 1
      - name: Test 'dry-run' input
        uses: ./
        with:
          dry-run: true
          github-token: ${{ secrets.GH_TOKEN }}

      # test 2
      - name: Test 'without-prefix' input
        uses: ./
        with:
          dry-run: true
          without-prefix: true
          github-token: ${{ secrets.GH_TOKEN }}

      # test 3
      - name: Test 'major-tag=true' input
        uses: ./
        with:
          dry-run: true
          major-tag: true
          github-token: ${{ secrets.GH_TOKEN }}

      # test 4
      - name: Test 'major-tag=false' input
        uses: ./
        with:
          dry-run: true
          major-tag: false
          github-token: ${{ secrets.GH_TOKEN }}

      # test 5
      - name: Test 'major-tag=auto' input
        uses: ./
        with:
          dry-run: true
          major-tag: auto
          github-token: ${{ secrets.GH_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: os-testing
    permissions:
      contents: write
      issues: write
      id-token: write
      packages: write
    concurrency:
      group: release-${{ github.ref }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Release That
        uses: ./
        with:
          github-token: ${{ secrets.GH_TOKEN }}
